---
fullnameOverride: prometheus

alertmanager:
  alertmanagerSpec:
    storage:
      volumeClaimTemplate:
        spec:
          resources:
            requests:
              storage: 1Gi
  config:
    global:
      slack_api_url: '${SECRET_DISCORD_ALERT_WEBHOOK_URL}/slack'
    receivers:
      - name: 'null'
      - name: discord
        slack_configs:
          - channel: '#x86kube-alarms'
            icon_url: 'https://avatars3.githubusercontent.com/u/3380462'
            send_resolved: true
            text: >-
              {{ range .Alerts -}}
                **Alert:** {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}
              **Description:** {{ if ne .Annotations.description ""}}{{
              .Annotations.description }}{{else}}N/A{{ end }} **Details:**
                {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
                {{ end }}
              {{ end }}
            title: >-
              [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{
              .Alerts.Firing | len }}{{ end }}] {{ if ne
              .CommonAnnotations.summary ""}}{{ .CommonAnnotations.summary }}{{
              else }}{{ .CommonLabels.alertname }}{{ end }}
            username: Prometheus
    route:
      routes:
        - matchers:
            - alertname =~ "InfoInhibitor|Watchdog"
          receiver: 'null'
        - continue: true
          match_re:
            severity: critical
          receiver: discord
  ingress:
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      kubernetes.io/tls-acme: 'true'
    enabled: true
    hosts:
      - &host 'alerts.${SECRET_DOMAIN}'
    ingressClassName: nginx
    pathType: Prefix
    tls:
      - hosts:
          - *host
        secretName: alertmanager-tls
  serviceAccount:
    create: true
    name: alertmanager
  rules:
    kubeControllerManager: false
    kubeProxy: false
    kubeScheduler: false

grafana:
  adminPassword: ${GRAFANA_ADMIN_PASSWORD}
  grafana.ini:
    server:
      root_url: https://graphs.${SECRET_DOMAIN}/
    auth.google:
      enabled: true
      client_id: ${GRAFANA_GOOGLE_CLIENT_ID}
      client_secret: ${GRAFANA_GOOGLE_CLIENT_SECRET}
      scopes: "https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email"
      auth_url: https://accounts.google.com/o/oauth2/auth
      token_url: https://accounts.google.com/o/oauth2/token
      allowed_domains: ${GRAFANA_GOOGLE_ALLOWED_DOMAINS}
  sidecar:
    datasources:
      defaultDatasourceEnabled: false
  additionalDataSources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://thanos-query:9090/
    - name: Loki
      type: loki
      access: proxy
      url: 'http://loki-gateway.monitoring.svc.cluster.local'
  ingress:
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      kubernetes.io/tls-acme: 'true'
    enabled: true
    hosts:
      - 'graphs.${SECRET_DOMAIN}'
    tls:
      - hosts:
          - 'graphs.${SECRET_DOMAIN}'
        secretName: grafana-tls
  persistence:
    enabled: true
    size: 1Gi
kubeProxy:
  enabled: false
nodeExporter:
  enabled: true
  serviceMonitor:
    relabelings:
      - action: replace
        regex: (.*)
        replacement: $1
        sourceLabels:
          - __meta_kubernetes_pod_node_name
        targetLabel: kubernetes_node

prometheus:
  thanosService:
    enabled: true
  thanosServiceMonitor:
    enabled: true
  ingress:
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      kubernetes.io/tls-acme: 'true'
    enabled: true
    hosts:
      - &host 'prometheus.${SECRET_DOMAIN}'
    ingressClassName: nginx
    pathType: Prefix
    tls:
      - hosts:
          - *host
        secretName: prometheus-tls
  prometheusSpec:
    retention: 12h
    replicaExternalLabelName: replica
    securityContext:
      fsGroup: 0
      runAsGroup: 0
      runAsNonRoot: false
      runAsUser: 0
    storageSpec:
      volumeClaimTemplate:
        spec:
          resources:
            requests:
              storage: 50Gi
    thanos:
      image: quay.io/thanos/thanos:v0.28.1
      objectStorageConfig:
        name: thanos-objstore-secret
        key: objstore.yml
      # renovate: datasource=docker depName=quay.io/thanos/thanos
      version: "v0.28.1"
    walCompression: true
